steps:
  build:
    image: maven:3.8.1-openjdk-17
    commands:
      - echo "start run the build step "
      - echo $${WOODPECKER_NOTIFY_DISCORD_ID}
      - echo $${WOODPECKER_NOTIFY_DISCORD_TOKEN}
    secrets: [WOODPECKER_NOTIFY_DISCORD_ID, WOODPECKER_NOTIFY_DISCORD_TOKEN]
    when:
      event:
        - pull_request
        - tag
        - release

  compile:
    image: maven:3.8.1-openjdk-17
    commands:
      - mvn clean
      - mvn compile
      - echo "compile finish"
    when:
      event: pull_request

  spotbugs:
    image: maven:3.8.1-openjdk-17
    commands:
      - mvn clean
      - mvn compile
      - mvn spotbugs:check -Dspotbugs.excludeFilterFile=./findbugs-exclude.xml #exclude bug list
    when:
      event: pull_request

  pmd:
    image: maven:3.8.1-openjdk-17
    commands:
      - mvn clean
      - mvn compile
      - mvn pmd:pmd
    when:
      event: pull_request

#  test:
#    image: maven:3.8.1-openjdk-17
#    commands:
#      - mvn test

  release:
    image: maven:3.8.1-openjdk-17
    environment:
      maven_username:
        from_secret: maven_username
      maven_password:
        from_secret: maven_password
    commands:
      - echo "ğŸ§ª Build triggered by Git tag - $CI_COMMIT_TAG"
      - mvn versions:set -DnewVersion=${CI_COMMIT_TAG#v} -DgenerateBackupPoms=false
      - mkdir -p ~/.m2
      - |
        cat > ~/.m2/settings.xml <<EOF
        <settings>
        <servers>
        <server>
        <id>jdk</id>
        <username>${maven_username}</username>
        <password>${maven_password}</password>
        </server>
        </servers>
        </settings>
        EOF
        - mvn clean deploy -DskipTests
    when:
      event:
        - tag
        - release





  # è¨­å®šé€šçŸ¥ï¼Œdiscord ä½œç‚ºé€šçŸ¥å·¥å…·
  notify:
    image: appleboy/drone-discord
    settings:
      webhook_id: 
        from_secret: woodpecker_notify_discord_id
      webhook_token: 
        from_secret: woodpecker_notify_discord_token
      avatar_url: https://woodpecker-ci.org/img/logo.svg
      link_names: true
      template: >
    when:
      event:
        - pull_request
        - tag
        - release
      status:
        - failure
        - success
